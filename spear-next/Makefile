# SPEAR Next Makefile / SPEAR Nextæ„å»ºæ–‡ä»¶
# This Makefile provides targets for building, testing, and analyzing the SPEAR Next project
# æ­¤Makefileä¸ºSPEAR Nexté¡¹ç›®æä¾›æ„å»ºã€æµ‹è¯•å’Œåˆ†æç›®æ ‡

# Project configuration / é¡¹ç›®é…ç½®
PROJECT_NAME := spear-next
VERSION := $(shell git describe --tags --match "*" --always --dirty 2>/dev/null || echo "dev")
REPO_ROOT := $(shell pwd)
TARGET_DIR := $(REPO_ROOT)/target
COVERAGE_DIR := $(TARGET_DIR)/coverage

# Rust configuration / Rusté…ç½®
CARGO := cargo
RUSTC_VERSION := $(shell rustc --version 2>/dev/null || echo "unknown")

# Colors for output / è¾“å‡ºé¢œè‰²
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m # No Color

.PHONY: all build test clean coverage coverage-quick install-deps format lint check doc help

# Default target / é»˜è®¤ç›®æ ‡
all: check test build

# Display help information / æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo -e "$(BLUE)SPEAR Next Build System / SPEAR Nextæ„å»ºç³»ç»Ÿ$(NC)"
	@echo "=================================================="
	@echo ""
	@echo -e "$(GREEN)Available targets / å¯ç”¨ç›®æ ‡:$(NC)"
	@echo "  build           - Build the project / æ„å»ºé¡¹ç›®"
	@echo "  test            - Run all tests / è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  coverage        - Run comprehensive code coverage analysis / è¿è¡Œå…¨é¢ä»£ç è¦†ç›–ç‡åˆ†æ"
	@echo "  coverage-quick  - Run quick code coverage analysis / è¿è¡Œå¿«é€Ÿä»£ç è¦†ç›–ç‡åˆ†æ"
	@echo "  clean           - Clean build artifacts / æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  format          - Format code / æ ¼å¼åŒ–ä»£ç "
	@echo "  lint            - Run linter / è¿è¡Œä»£ç æ£€æŸ¥"
	@echo "  check           - Run cargo check / è¿è¡Œcargoæ£€æŸ¥"
	@echo "  doc             - Generate documentation / ç”Ÿæˆæ–‡æ¡£"
	@echo "  install-deps    - Install development dependencies / å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  help            - Show this help message / æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo -e "$(YELLOW)Examples / ç¤ºä¾‹:$(NC)"
	@echo "  make build                    # Build with default features / ä½¿ç”¨é»˜è®¤ç‰¹æ€§æ„å»º"
	@echo "  make test                     # Run all tests / è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make coverage-quick           # Quick coverage analysis / å¿«é€Ÿè¦†ç›–ç‡åˆ†æ"
	@echo "  make FEATURES=sled build      # Build with sled feature / ä½¿ç”¨sledç‰¹æ€§æ„å»º"
	@echo ""

# Install development dependencies / å®‰è£…å¼€å‘ä¾èµ–
install-deps:
	@echo -e "$(BLUE)ğŸ“¦ Installing development dependencies... / å®‰è£…å¼€å‘ä¾èµ–...$(NC)"
	@if ! command -v cargo-tarpaulin >/dev/null 2>&1; then \
		echo -e "$(YELLOW)Installing cargo-tarpaulin... / å®‰è£…cargo-tarpaulin...$(NC)"; \
		$(CARGO) install cargo-tarpaulin; \
	fi
	@if ! command -v cargo-audit >/dev/null 2>&1; then \
		echo -e "$(YELLOW)Installing cargo-audit... / å®‰è£…cargo-audit...$(NC)"; \
		$(CARGO) install cargo-audit; \
	fi
	@if ! command -v cargo-outdated >/dev/null 2>&1; then \
		echo -e "$(YELLOW)Installing cargo-outdated... / å®‰è£…cargo-outdated...$(NC)"; \
		$(CARGO) install cargo-outdated; \
	fi
	@echo -e "$(GREEN)âœ… Development dependencies installed / å¼€å‘ä¾èµ–å®‰è£…å®Œæˆ$(NC)"

# Build the project / æ„å»ºé¡¹ç›®
build:
	@echo -e "$(BLUE)ğŸ”¨ Building $(PROJECT_NAME)... / æ„å»º$(PROJECT_NAME)...$(NC)"
	@if [ -n "$(FEATURES)" ]; then \
		echo -e "$(YELLOW)Building with features: $(FEATURES) / ä½¿ç”¨ç‰¹æ€§æ„å»º: $(FEATURES)$(NC)"; \
		$(CARGO) build --features $(FEATURES); \
	else \
		$(CARGO) build; \
	fi
	@echo -e "$(GREEN)âœ… Build completed / æ„å»ºå®Œæˆ$(NC)"

# Build release version / æ„å»ºå‘å¸ƒç‰ˆæœ¬
build-release:
	@echo -e "$(BLUE)ğŸš€ Building release version... / æ„å»ºå‘å¸ƒç‰ˆæœ¬...$(NC)"
	@if [ -n "$(FEATURES)" ]; then \
		$(CARGO) build --release --features $(FEATURES); \
	else \
		$(CARGO) build --release; \
	fi
	@echo -e "$(GREEN)âœ… Release build completed / å‘å¸ƒç‰ˆæœ¬æ„å»ºå®Œæˆ$(NC)"

# Run tests / è¿è¡Œæµ‹è¯•
test:
	@echo -e "$(BLUE)ğŸ§ª Running tests... / è¿è¡Œæµ‹è¯•...$(NC)"
	@if [ -n "$(FEATURES)" ]; then \
		$(CARGO) test --features $(FEATURES); \
	else \
		$(CARGO) test; \
	fi
	@echo -e "$(GREEN)âœ… Tests completed / æµ‹è¯•å®Œæˆ$(NC)"

# Run tests with specific feature / è¿è¡Œç‰¹å®šç‰¹æ€§çš„æµ‹è¯•
test-sled:
	@echo -e "$(BLUE)ğŸ§ª Running tests with sled feature... / è¿è¡Œsledç‰¹æ€§æµ‹è¯•...$(NC)"
	$(CARGO) test --features sled

test-rocksdb:
	@echo -e "$(BLUE)ğŸ§ª Running tests with rocksdb feature... / è¿è¡Œrocksdbç‰¹æ€§æµ‹è¯•...$(NC)"
	$(CARGO) test --features rocksdb

test-all-features:
	@echo -e "$(BLUE)ğŸ§ª Running tests with all features... / è¿è¡Œæ‰€æœ‰ç‰¹æ€§æµ‹è¯•...$(NC)"
	$(CARGO) test --all-features

# Run comprehensive code coverage analysis / è¿è¡Œå…¨é¢ä»£ç è¦†ç›–ç‡åˆ†æ
coverage: install-deps
	@echo -e "$(BLUE)ğŸ“Š Running comprehensive code coverage analysis... / è¿è¡Œå…¨é¢ä»£ç è¦†ç›–ç‡åˆ†æ...$(NC)"
	@./scripts/coverage.sh
	@echo -e "$(GREEN)âœ… Coverage analysis completed / è¦†ç›–ç‡åˆ†æå®Œæˆ$(NC)"

# Run quick code coverage analysis / è¿è¡Œå¿«é€Ÿä»£ç è¦†ç›–ç‡åˆ†æ
coverage-quick:
	@echo -e "$(BLUE)ğŸ“Š Running quick coverage analysis... / è¿è¡Œå¿«é€Ÿè¦†ç›–ç‡åˆ†æ...$(NC)"
	@./scripts/quick-coverage.sh
	@echo -e "$(GREEN)âœ… Quick coverage analysis completed / å¿«é€Ÿè¦†ç›–ç‡åˆ†æå®Œæˆ$(NC)"

# Open coverage report / æ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š
coverage-open:
	@if [ -f "$(COVERAGE_DIR)/index.html" ]; then \
		echo -e "$(BLUE)ğŸŒ Opening comprehensive coverage report... / æ‰“å¼€å…¨é¢è¦†ç›–ç‡æŠ¥å‘Š...$(NC)"; \
		open "$(COVERAGE_DIR)/index.html" 2>/dev/null || xdg-open "$(COVERAGE_DIR)/index.html" 2>/dev/null || echo -e "$(YELLOW)Please open $(COVERAGE_DIR)/index.html manually / è¯·æ‰‹åŠ¨æ‰“å¼€$(COVERAGE_DIR)/index.html$(NC)"; \
	elif [ -f "$(COVERAGE_DIR)/tarpaulin-report.html" ]; then \
		echo -e "$(BLUE)ğŸŒ Opening quick coverage report... / æ‰“å¼€å¿«é€Ÿè¦†ç›–ç‡æŠ¥å‘Š...$(NC)"; \
		open "$(COVERAGE_DIR)/tarpaulin-report.html" 2>/dev/null || xdg-open "$(COVERAGE_DIR)/tarpaulin-report.html" 2>/dev/null || echo -e "$(YELLOW)Please open $(COVERAGE_DIR)/tarpaulin-report.html manually / è¯·æ‰‹åŠ¨æ‰“å¼€$(COVERAGE_DIR)/tarpaulin-report.html$(NC)"; \
	else \
		echo -e "$(RED)âŒ No coverage report found. Run 'make coverage' or 'make coverage-quick' first / æœªæ‰¾åˆ°è¦†ç›–ç‡æŠ¥å‘Šã€‚è¯·å…ˆè¿è¡Œ'make coverage'æˆ–'make coverage-quick'$(NC)"; \
	fi

# Clean build artifacts / æ¸…ç†æ„å»ºäº§ç‰©
clean:
	@echo -e "$(BLUE)ğŸ§¹ Cleaning build artifacts... / æ¸…ç†æ„å»ºäº§ç‰©...$(NC)"
	$(CARGO) clean
	rm -rf $(COVERAGE_DIR)
	@echo -e "$(GREEN)âœ… Clean completed / æ¸…ç†å®Œæˆ$(NC)"

# Format code / æ ¼å¼åŒ–ä»£ç 
format:
	@echo -e "$(BLUE)ğŸ¨ Formatting code... / æ ¼å¼åŒ–ä»£ç ...$(NC)"
	$(CARGO) fmt
	@echo -e "$(GREEN)âœ… Code formatted / ä»£ç æ ¼å¼åŒ–å®Œæˆ$(NC)"

# Check code formatting / æ£€æŸ¥ä»£ç æ ¼å¼
format-check:
	@echo -e "$(BLUE)ğŸ” Checking code formatting... / æ£€æŸ¥ä»£ç æ ¼å¼...$(NC)"
	$(CARGO) fmt --check

# Run linter / è¿è¡Œä»£ç æ£€æŸ¥
lint:
	@echo -e "$(BLUE)ğŸ” Running linter... / è¿è¡Œä»£ç æ£€æŸ¥...$(NC)"
	$(CARGO) clippy -- -D warnings
	@echo -e "$(GREEN)âœ… Linting completed / ä»£ç æ£€æŸ¥å®Œæˆ$(NC)"

# Run cargo check / è¿è¡Œcargoæ£€æŸ¥
check:
	@echo -e "$(BLUE)âœ… Running cargo check... / è¿è¡Œcargoæ£€æŸ¥...$(NC)"
	$(CARGO) check
	@if [ -n "$(FEATURES)" ]; then \
		$(CARGO) check --features $(FEATURES); \
	fi
	@echo -e "$(GREEN)âœ… Check completed / æ£€æŸ¥å®Œæˆ$(NC)"

# Generate documentation / ç”Ÿæˆæ–‡æ¡£
doc:
	@echo -e "$(BLUE)ğŸ“š Generating documentation... / ç”Ÿæˆæ–‡æ¡£...$(NC)"
	$(CARGO) doc --no-deps --open
	@echo -e "$(GREEN)âœ… Documentation generated / æ–‡æ¡£ç”Ÿæˆå®Œæˆ$(NC)"

# Run benchmarks / è¿è¡ŒåŸºå‡†æµ‹è¯•
bench:
	@echo -e "$(BLUE)âš¡ Running benchmarks... / è¿è¡ŒåŸºå‡†æµ‹è¯•...$(NC)"
	$(CARGO) bench
	@echo -e "$(GREEN)âœ… Benchmarks completed / åŸºå‡†æµ‹è¯•å®Œæˆ$(NC)"

# Security audit / å®‰å…¨å®¡è®¡
audit: install-deps
	@echo -e "$(BLUE)ğŸ”’ Running security audit... / è¿è¡Œå®‰å…¨å®¡è®¡...$(NC)"
	$(CARGO) audit
	@echo -e "$(GREEN)âœ… Security audit completed / å®‰å…¨å®¡è®¡å®Œæˆ$(NC)"

# Check for outdated dependencies / æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
outdated: install-deps
	@echo -e "$(BLUE)ğŸ“¦ Checking for outdated dependencies... / æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–...$(NC)"
	$(CARGO) outdated
	@echo -e "$(GREEN)âœ… Dependency check completed / ä¾èµ–æ£€æŸ¥å®Œæˆ$(NC)"

# Full CI pipeline / å®Œæ•´CIæµæ°´çº¿
ci: format-check lint check test coverage-quick
	@echo -e "$(GREEN)ğŸ‰ CI pipeline completed successfully! / CIæµæ°´çº¿æˆåŠŸå®Œæˆï¼$(NC)"

# Development workflow / å¼€å‘å·¥ä½œæµ
dev: format lint test
	@echo -e "$(GREEN)ğŸš€ Development workflow completed! / å¼€å‘å·¥ä½œæµå®Œæˆï¼$(NC)"

# Show project information / æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo -e "$(BLUE)ğŸ“‹ Project Information / é¡¹ç›®ä¿¡æ¯$(NC)"
	@echo "=================================================="
	@echo "Project Name / é¡¹ç›®åç§°: $(PROJECT_NAME)"
	@echo "Version / ç‰ˆæœ¬: $(VERSION)"
	@echo "Rust Version / Rustç‰ˆæœ¬: $(RUSTC_VERSION)"
	@echo "Repository Root / ä»“åº“æ ¹ç›®å½•: $(REPO_ROOT)"
	@echo "Target Directory / ç›®æ ‡ç›®å½•: $(TARGET_DIR)"
	@echo "Coverage Directory / è¦†ç›–ç‡ç›®å½•: $(COVERAGE_DIR)"
	@echo ""